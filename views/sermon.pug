extends layout

block content
  nav.navbar.navbar-light.bg-light
    ul.navbar-nav.mr-auto
      li.nav-item
        a.nav-link(href=`/${user.id}`)
          img(src="/images/back.svg")
    .mx-auto.order-0
      a.navbar-brand.mx-auto(href='/')=user.ministryName
    ul.navbar-nav.ml-auto
  .container.mt-3
    h3=sermon.title
    h6.mb-2.text-muted=sermon.preachedOn
    p=sermon.description
    p
      p.bibleReferences
        span Bible passages: &nbsp
        span
          a#bibleLink(href=sermon.bibleLink target="_blank")=sermon.bibleReferences
    p.audio
      audio#audioPlayer(controls=true)
        source(src=sermon.url,type=contentType)
    button#playButton.btn.btn-primary.mr-3(onclick="audioPlayer.play();") Play
    button#pauseButton.btn.btn-primary.mr-3(onclick="audioPlayer.pause();", style="display: none;") Pause
    a.btn.btn-primary(href=`/${user.id}/sermon/${sermon.id}/download`) Download

    script.
      var audioPlayer = document.getElementById('audioPlayer');
      var playButton = document.getElementById('playButton');
      var pauseButton = document.getElementById('pauseButton');
      var bibleLink = document.getElementById('bibleLink');
      // When paused show play button.
      audioPlayer.addEventListener('pause', function() {
        playButton.style.display = 'inline-block';
        pauseButton.style.display = 'none';
      })
      // When playing show pause button.
      audioPlayer.addEventListener('play', function() {
        playButton.style.display = 'none';
        pauseButton.style.display = 'inline-block';
      })
      // Analytics. Log bible link click.
      var bibleLinkClicked = false;
      bibleLink.addEventListener('click', function() {
        if (bibleLinkClicked) return;
        gtag('event', 'bible_link_click', {
          'event_category': '#{user.ministryName}',
          'event_label': '#{sermon.title}'
        });
        bibleLinkClicked = true;
      })
      // Analytics. Log inital play event.
      var startLogged = false;
      audioPlayer.addEventListener('play', function() {
        if (startLogged) return;
        gtag('event', 'listen_start', {
          'event_category': '#{user.ministryName}',
          'event_label': '#{sermon.title}'
        });
        startLogged = true;
      })
      // Analytics. Log listened to end.
      var completeLogged = false;
      audioPlayer.addEventListener('timeupdate', function (event) {        
        if (completeLogged) return;
        // If listener gets to the last 30 seconds treat as complete
        if (event.target.duration - event.target.currentTime > 30) return;
        gtag('event', 'listen_complete', {
          'event_category': '#{user.ministryName}',
          'event_label': '#{sermon.title}'
        });
        completeLogged = true;
      })
